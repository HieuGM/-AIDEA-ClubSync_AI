{% extends "base.html" %}

{% block content %}
<div class="container">
    <div class="row">
        <div class="col-12">
            <div class="d-flex justify-content-between align-items-center mb-4">
                <h2><i class="bi bi-clock"></i> Quản lý thời gian bận</h2>
                <button type="button" class="btn btn-primary" id="saveAvailability">
                    <i class="bi bi-save"></i> Lưu thay đổi
                </button>
            </div>
            
            <div class="alert alert-info">
                <i class="bi bi-info-circle"></i>
                <strong>Hướng dẫn:</strong> Tick vào các ô thời gian mà bạn bận để hệ thống có thể đưa ra gợi ý đặt phòng phù hợp.
            </div>
            
            <div class="card">
                <div class="card-header">
                    <h5 class="mb-0">Lịch thời gian bận trong tuần</h5>
                </div>
                <div class="card-body">
                    <div class="table-responsive">
                        <table class="table table-bordered table-sm">
                            <thead class="table-dark">
                                <tr>
                                    <th style="width: 100px;">Giờ</th>
                                    <th>Thứ 2</th>
                                    <th>Thứ 3</th>
                                    <th>Thứ 4</th>
                                    <th>Thứ 5</th>
                                    <th>Thứ 6</th>
                                    <th>Thứ 7</th>
                                    <th>Chủ nhật</th>
                                </tr>
                            </thead>
                            <tbody id="availabilityTable">
                                <!-- Time slots will be generated by JavaScript -->
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
            
            <!-- Statistics -->
            <div class="row mt-4">
                <div class="col-md-6">
                    <div class="card">
                        <div class="card-header">
                            <h6 class="mb-0">Thống kê thời gian bận</h6>
                        </div>
                        <div class="card-body">
                            <canvas id="busyTimeChart" height="200"></canvas>
                        </div>
                    </div>
                </div>
                
                <div class="col-md-6">
                    <div class="card">
                        <div class="card-header">
                            <h6 class="mb-0">Gợi ý thời gian rảnh</h6>
                        </div>
                        <div class="card-body" id="suggestionsList">
                            <!-- Suggestions will be loaded here -->
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
document.addEventListener('DOMContentLoaded', function() {
    const days = ['Thứ 2', 'Thứ 3', 'Thứ 4', 'Thứ 5', 'Thứ 6', 'Thứ 7', 'Chủ nhật'];
    const hours = Array.from({length: 14}, (_, i) => i + 6); // 6 AM to 7 PM
    let availabilityData = {};
    
    // Initialize availability table
    function initTable() {
        const tableBody = document.getElementById('availabilityTable');
        tableBody.innerHTML = '';
        
        hours.forEach(hour => {
            const row = document.createElement('tr');
            row.innerHTML = `
                <td class="fw-bold text-center">${hour}:00 - ${hour + 1}:00</td>
                ${days.map((day, dayIndex) => `
                    <td class="text-center">
                        <div class="form-check d-inline-block">
                            <input class="form-check-input" type="checkbox" 
                                   id="time_${dayIndex}_${hour}" 
                                   data-day="${dayIndex}" 
                                   data-hour="${hour}">
                        </div>
                    </td>
                `).join('')}
            `;
            tableBody.appendChild(row);
        });
        
        // Add event listeners
        document.querySelectorAll('input[type="checkbox"]').forEach(checkbox => {
            checkbox.addEventListener('change', updateAvailability);
        });
    }
    
    // Load existing availability
    function loadAvailability() {
        fetch('{{ url_for("api.user_availability") }}')
            .then(response => response.json())
            .then(data => {
                data.forEach(item => {
                    for (let hour = item.start_hour; hour < item.end_hour; hour++) {
                        const checkbox = document.getElementById(`time_${item.day_of_week}_${hour}`);
                        if (checkbox && item.is_busy) {
                            checkbox.checked = true;
                        }
                    }
                });
                updateChart();
                updateSuggestions();
            })
            .catch(error => console.error('Error loading availability:', error));
    }
    
    // Update availability data
    function updateAvailability() {
        updateChart();
        updateSuggestions();
    }
    
    // Save availability
    function saveAvailability() {
        const availability = [];
        
        // Group consecutive hours for each day
        days.forEach((day, dayIndex) => {
            let busyHours = [];
            hours.forEach(hour => {
                const checkbox = document.getElementById(`time_${dayIndex}_${hour}`);
                if (checkbox && checkbox.checked) {
                    busyHours.push(hour);
                }
            });
            
            // Convert to ranges
            if (busyHours.length > 0) {
                let start = busyHours[0];
                let end = start;
                
                for (let i = 1; i < busyHours.length; i++) {
                    if (busyHours[i] === busyHours[i-1] + 1) {
                        end = busyHours[i];
                    } else {
                        // Save the range
                        availability.push({
                            day_of_week: dayIndex,
                            start_hour: start,
                            end_hour: end + 1,
                            is_busy: true,
                            recurring: true
                        });
                        start = busyHours[i];
                        end = start;
                    }
                }
                
                // Save the last range
                availability.push({
                    day_of_week: dayIndex,
                    start_hour: start,
                    end_hour: end + 1,
                    is_busy: true,
                    recurring: true
                });
            }
        });
        
        fetch('{{ url_for("api.user_availability") }}', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify({ availability: availability })
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                alert('Đã lưu thành công!');
            } else {
                alert('Có lỗi xảy ra khi lưu!');
            }
        })
        .catch(error => {
            console.error('Error saving availability:', error);
            alert('Có lỗi xảy ra khi lưu!');
        });
    }
    
    // Update chart
    function updateChart() {
        const busyCount = days.map((day, dayIndex) => {
            return hours.filter(hour => {
                const checkbox = document.getElementById(`time_${dayIndex}_${hour}`);
                return checkbox && checkbox.checked;
            }).length;
        });
        
        const ctx = document.getElementById('busyTimeChart').getContext('2d');
        
        if (window.busyChart) {
            window.busyChart.destroy();
        }
        
        window.busyChart = new Chart(ctx, {
            type: 'bar',
            data: {
                labels: days,
                datasets: [{
                    label: 'Số giờ bận',
                    data: busyCount,
                    backgroundColor: 'rgba(255, 99, 132, 0.2)',
                    borderColor: 'rgba(255, 99, 132, 1)',
                    borderWidth: 1
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                scales: {
                    y: {
                        beginAtZero: true,
                        max: hours.length
                    }
                }
            }
        });
    }
    
    // Update suggestions
    function updateSuggestions() {
        const freeSlots = [];
        
        days.forEach((day, dayIndex) => {
            const dayFreeSlots = hours.filter(hour => {
                const checkbox = document.getElementById(`time_${dayIndex}_${hour}`);
                return checkbox && !checkbox.checked;
            });
            
            if (dayFreeSlots.length > 0) {
                freeSlots.push({
                    day: day,
                    slots: dayFreeSlots.length,
                    hours: dayFreeSlots
                });
            }
        });
        
        // Sort by most free time
        freeSlots.sort((a, b) => b.slots - a.slots);
        
        const suggestionsList = document.getElementById('suggestionsList');
        if (freeSlots.length > 0) {
            suggestionsList.innerHTML = `
                <h6>Các ngày có nhiều thời gian rảnh nhất:</h6>
                <ul class="list-group list-group-flush">
                    ${freeSlots.slice(0, 3).map(slot => `
                        <li class="list-group-item d-flex justify-content-between align-items-center">
                            ${slot.day}
                            <span class="badge bg-success rounded-pill">${slot.slots} giờ rảnh</span>
                        </li>
                    `).join('')}
                </ul>
            `;
        } else {
            suggestionsList.innerHTML = '<p class="text-muted">Bạn đã đánh dấu bận toàn bộ thời gian!</p>';
        }
    }
    
    // Initialize
    initTable();
    loadAvailability();
    
    // Save button event
    document.getElementById('saveAvailability').addEventListener('click', saveAvailability);
});
</script>
{% endblock %}